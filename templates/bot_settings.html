<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Settings - CHATA</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="icon" href="{{ url_for('static', filename='images/icon.png') }}">
    <style>
        :root {
            --chata-blue: #3366ff;
            --chata-blue-light: #4d7cff;
            --chata-blue-dark: #1a4dcc;
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-bg: rgba(15, 20, 35, 0.55);
      --glass-bg-strong: rgba(18, 25, 46, 0.75);
        }
        
        * {
            box-sizing: border-box;
        }

        body {
      margin: 0;
            font-family: 'Inter', sans-serif;
      background: #000;
      color: #fff;
            min-height: 100vh;
      letter-spacing: 0.06em;
      overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.12);
      backdrop-filter: blur(2px);
            z-index: 1;
            pointer-events: none;
        }

    a {
      color: inherit;
      text-decoration: none;
    }

        .interactive-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
      height: 600%;
            z-index: -1;
      background: #000;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
      overflow: hidden;
      transition: transform 0.3s ease;
      pointer-events: none;
        }

        .grid-cell {
            position: absolute;
            width: 50px;
            height: 50px;
      border: 1px solid rgba(51, 102, 255, 0.08);
      transition: background 0.6s ease, border-color 0.6s ease, box-shadow 0.6s ease, transform 0.6s ease;
            background: transparent;
      pointer-events: none;
        }
        
        .grid-cell.active {
      background: rgba(51, 102, 255, 0.15);
      border-color: rgba(51, 102, 255, 0.45);
      box-shadow: 0 0 25px rgba(51, 102, 255, 0.4);
      transform: scale(1.03);
    }

    nav {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 50;
      backdrop-filter: blur(16px);
      background: rgba(0, 0, 0, 0.35);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .nav-container {
      max-width: 1200px;
             margin: 0 auto;
      padding: 0 1.5rem;
      height: 72px;
      display: flex;
      align-items: center;
             position: relative;
    }

    .logo {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: 0.2em;
      color: var(--chata-blue);
    }

    .nav-links {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
            display: flex;
      align-items: center;
            gap: 2rem;
      font-size: 0.85rem;
      letter-spacing: 0.18em;
    }

    .nav-links a {
      position: relative;
      padding: 0.25rem 0;
      transition: color 0.3s ease;
    }

    .nav-links a::after {
      content: "";
      position: absolute;
      bottom: -6px;
      left: 0;
      width: 0;
      height: 1px;
      background: var(--chata-blue);
      transition: width 0.3s ease;
    }

    .nav-links a:hover {
      color: var(--chata-blue);
    }

    .nav-links a:hover::after {
      width: 100%;
    }

    .nav-actions {
      position: absolute;
      right: 1.5rem;
            display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      letter-spacing: 0.18em;
    }

    .nav-actions a {
      padding: 0.4rem 0.6rem;
      border-radius: 999px;
    }

    .nav-actions .logout {
      background: linear-gradient(135deg, var(--chata-blue) 0%, var(--chata-blue-light) 100%);
      color: #fff;
      box-shadow: 0 8px 24px rgba(51, 102, 255, 0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .nav-actions .logout:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 32px rgba(51, 102, 255, 0.4);
    }

    .bot-settings-hero {
      padding-top: 140px;
      padding-bottom: 48px;
      text-align: center;
      position: relative;
      z-index: 5;
    }

    .bot-settings-hero h1 {
      font-size: 3.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      text-transform: uppercase;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #fff, #ccc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .bot-settings-hero p {
      max-width: 560px;
      margin: 0 auto;
      font-size: 1.2rem;
      font-weight: 300;
      letter-spacing: 0.05em;
      color: #888;
      text-transform: none;
    }

    .bot-settings-content {
      max-width: 1180px;
      margin: 0 auto 96px;
      padding: 0 1.5rem 2rem;
      position: relative;
      z-index: 5;
    }

    .alert {
      max-width: 1180px;
      margin: 0 auto 1.5rem;
      padding: 0.9rem 1.2rem;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.18);
      font-size: 0.85rem;
      letter-spacing: 0.12em;
      text-transform: none;
      position: relative;
      z-index: 20;
    }

    .alert-success {
      background: rgba(51, 102, 255, 0.08);
      border-color: rgba(51, 102, 255, 0.4);
      color: #cdd9ff;
      position: relative;
      z-index: 20;
    }

    .alert-error,
    .alert-warning {
      background: rgba(255, 107, 107, 0.08);
      border-color: rgba(255, 107, 107, 0.35);
      color: #ffd6d6;
      position: relative;
      z-index: 20;
    }

    .connection-banner {
      margin-bottom: 1.5rem;
      padding: 1rem 1.5rem;
      border-radius: 16px;
      background: var(--glass-bg-strong);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(18px);
            display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: center;
      letter-spacing: 0.1em;
      text-transform: none;
    }

    .connection-banner strong {
      font-weight: 600;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.8);
    }

    .connection-banner span {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .settings-form {
            display: flex;
            flex-direction: column;
      gap: 1.75rem;
    }

    .section-card {
      padding: 2rem;
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(16px);
    }

    .section-header {
      margin-bottom: 1.5rem;
    }

    .section-header h2 {
      margin: 0 0 0.6rem;
      font-size: 1.1rem;
      letter-spacing: 0.28em;
      text-transform: uppercase;
      font-weight: 600;
    }

    .section-header p {
      margin: 0;
            font-size: 0.9rem;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.65);
      text-transform: none;
    }

    .form-grid {
            display: grid;
      gap: 1.25rem 1.5rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .form-group {
            display: flex;
            flex-direction: column;
      gap: 0.45rem;
      text-transform: none;
      letter-spacing: 0.05em;
    }

    .form-group label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.24em;
      color: rgba(255, 255, 255, 0.72);
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.05);
      border-radius: 14px;
      padding: 0.85rem 1rem;
      color: #fff;
      font-size: 0.92rem;
      font-weight: 400;
      letter-spacing: 0.05em;
      resize: none;
      transition: border 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      border-color: rgba(51, 102, 255, 0.7);
      box-shadow: 0 0 0 3px rgba(51, 102, 255, 0.15);
      background: rgba(255, 255, 255, 0.08);
      outline: none;
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(255, 255, 255, 0.45);
    }

    .char-counter {
      font-size: 0.7rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.35);
      align-self: flex-end;
    }

    .char-counter.near-limit {
      color: rgba(255, 125, 125, 0.8);
    }

    .conversation-examples {
      display: grid;
      gap: 2rem;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    }

    .conversation-example-card {
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(10, 15, 32, 0.7);
      padding: 1.5rem;
            display: flex;
            flex-direction: column;
      gap: 1rem;
      transition: border-color 0.3s ease, transform 0.3s ease;
    }

    .conversation-example-card:hover {
      border-color: rgba(51, 102, 255, 0.3);
      transform: translateY(-2px);
    }

    .conversation-title {
      margin: 0 0 1rem;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.2em;
            text-transform: uppercase;
      color: rgba(255, 255, 255, 0.85);
        }

    .dm-thread {
            display: flex;
            flex-direction: column;
            gap: 1rem;
    }

    .dm-message {
            display: flex;
      flex-direction: column;
      gap: 0.4rem;
      max-width: 85%;
    }

    .dm-message.follower-message {
      align-self: flex-start;
            align-items: flex-start;
    }

    .dm-message.bot-message {
      align-self: flex-end;
      align-items: flex-end;
    }

    .message-label {
      font-size: 0.7rem;
            text-transform: uppercase;
      letter-spacing: 0.2em;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 0.2rem;
    }

    .message-content {
      padding: 0.75rem 1rem;
      border-radius: 18px;
      font-size: 0.9rem;
      letter-spacing: 0.05em;
      color: rgba(255, 255, 255, 0.9);
      text-transform: none;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      word-wrap: break-word;
    }

    .dm-message.follower-message .message-content {
      border-bottom-left-radius: 4px;
      background: rgba(255, 255, 255, 0.06);
    }

    .dm-message.follower-message .message-input {
      width: 100%;
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: #fff;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      letter-spacing: 0.05em;
      resize: none;
      transition: border 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
      font-family: inherit;
    }

    .dm-message.follower-message .message-input:focus {
      border-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.08);
      outline: none;
    }

    .dm-message.bot-message .message-input {
      width: 100%;
      border-radius: 18px;
      border-bottom-right-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(51, 102, 255, 0.15);
      color: #fff;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      letter-spacing: 0.05em;
      resize: none;
      transition: border 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
      font-family: inherit;
    }

    .dm-message.bot-message .message-input:focus {
      border-color: rgba(51, 102, 255, 0.7);
      box-shadow: 0 0 0 3px rgba(51, 102, 255, 0.15);
      background: rgba(51, 102, 255, 0.2);
      outline: none;
    }

    .dm-message.bot-message .char-counter {
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.35);
      align-self: flex-end;
      margin-top: 0.2rem;
    }

    .conversation-input {
      min-height: 110px;
    }

    /* Scrollbar styling for textareas */
    textarea::-webkit-scrollbar {
      width: 6px;
    }

    textarea::-webkit-scrollbar-track {
             background: transparent;
    }

    textarea::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }

    textarea::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Firefox scrollbar */
    textarea {
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
    }

    .item-collection {
             display: flex;
             flex-direction: column;
      gap: 1rem;
    }

    .item-row {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      align-items: start;
      padding: 1rem;
            border-radius: 16px;
      background: rgba(6, 12, 26, 0.65);
      border: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
        }

    .remove-row-btn {
            position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: transparent;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    .remove-row-btn:hover {
      background: rgba(255, 99, 99, 0.18);
      border-color: rgba(255, 99, 99, 0.4);
      color: #ff9b9b;
    }

    .btn-primary,
    .btn-secondary,
    .btn-ghost {
      display: inline-flex;
            align-items: center;
      gap: 0.6rem;
      border-radius: 999px;
      padding: 0.9rem 1.8rem;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.24em;
            text-transform: uppercase;
      transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--chata-blue) 0%, var(--chata-blue-light) 100%);
             color: #fff;
      box-shadow: 0 16px 35px rgba(51, 102, 255, 0.34);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(51, 102, 255, 0.45);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.16);
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.12);
    }

    .btn-ghost {
      background: rgba(51, 102, 255, 0.12);
      color: rgba(187, 204, 255, 0.9);
      border: 1px dashed rgba(51, 102, 255, 0.35);
      font-size: 0.75rem;
      padding: 0.75rem 1.5rem;
      justify-content: center;
    }

    .btn-ghost:hover {
            background: rgba(51, 102, 255, 0.2);
      border-style: solid;
    }

        .action-buttons {
            display: flex;
      flex-wrap: wrap;
            gap: 1rem;
      justify-content: flex-end;
      margin-top: 1rem;
    }

    .empty-state {
      padding: 3rem;
      border-radius: 24px;
      background: var(--glass-bg);
      border: 1px dashed rgba(255, 255, 255, 0.12);
      text-align: center;
      letter-spacing: 0.08em;
      text-transform: none;
    }

    .empty-state h2 {
      margin: 0 0 1rem;
      font-size: 1rem;
      letter-spacing: 0.24em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.85);
    }

    .empty-state p {
      margin: 0 0 1.5rem;
      color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

    .empty-state a {
            display: inline-block;
      padding: 0.85rem 1.7rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(255, 255, 255, 0.08);
      font-size: 0.75rem;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.78);
      transition: background 0.25s ease, transform 0.25s ease;
    }

    .empty-state a:hover {
      background: rgba(255, 255, 255, 0.14);
            transform: translateY(-2px);
        }

    @media (max-width: 960px) {
      .nav-links {
        display: none;
      }

      .nav-actions {
        position: static;
        margin-left: auto;
      }

      .bot-settings-hero h1 {
        font-size: 2.6rem;
        letter-spacing: 0.32em;
      }

      .section-card {
        padding: 1.5rem;
      }
    }

    @media (max-width: 640px) {
      .bot-settings-hero {
        padding-top: 120px;
      }

            .bot-settings-hero h1 {
        font-size: 2.2rem;
        letter-spacing: 0.28em;
      }

      .connection-banner {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.6rem;
      }

      .item-row {
                grid-template-columns: 1fr;
        padding-right: 3rem;
      }

      .remove-row-btn {
        top: 0.6rem;
        right: 0.6rem;
            }

            .action-buttons {
        justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="interactive-grid" id="interactiveGrid"></div>

  <nav>
    <div class="nav-container">
      <a href="{{ url_for('home') }}" class="logo">CHATA</a>
      <div class="nav-links">
        <a href="{{ url_for('dashboard') }}">DASHBOARD</a>
        <a href="{{ url_for('home') }}">HOME</a>
                </div>
      <div class="nav-actions">
        <a href="{{ url_for('account_settings') }}">SETTINGS</a>
        <a href="{{ url_for('logout') }}" class="logout">LOGOUT</a>
            </div>
        </div>
    </nav>

    <section class="bot-settings-hero">
        <div>
            <h1>AI Settings</h1>
      <p>Give your AI the personality that best describes you.</p>
        </div>
    </section>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
      <div class="bot-settings-content" style="z-index: 20; position: relative;">
            {% for category, message in messages %}
          <div class="alert alert-{{ 'error' if category in ['error', 'danger', 'warning'] else category }}">
                    {{ message }}
                </div>
            {% endfor %}
      </div>
        {% endif %}
    {% endwith %}

     <main class="bot-settings-content">
    {% if not connections %}
      <div class="empty-state">
        <h2>NO INSTAGRAM CONNECTION</h2>
        <p>Hook up your Instagram account first so we know who we're mimicking.</p>
        <a href="{{ url_for('dashboard') }}">GO TO DASHBOARD</a>
                            </div>
    {% else %}
      <form id="botSettingsForm" method="POST" class="settings-form">
        <input type="hidden" name="connection_id" value="{{ selected_connection_id }}">

        <section class="section-card">
          <div class="section-header">
            <h2>Essentials</h2>
            <p>Baseline details your bot will casually reuse in conversation.</p>
                            </div>
          <div class="form-grid">
                            <div class="form-group">
                                <label for="bot_name">Name</label>
              <input type="text" id="bot_name" name="bot_name" placeholder="What do people call you?" value="{{ settings.bot_name if settings else '' }}">
                            </div>
                            <div class="form-group">
                                <label for="bot_age">Age</label>
              <input type="text" id="bot_age" name="bot_age" placeholder="Optional, keep it human." value="{{ settings.bot_age if settings else '' }}">
                            </div>
                            <div class="form-group">
              <label for="bot_location">Location</label>
              <input type="text" id="bot_location" name="bot_location" placeholder="Where are you based?" value="{{ settings.bot_location if settings else '' }}">
                            </div>
                            <div class="form-group">
              <label for="bot_occupation">What you do</label>
              <input type="text" id="bot_occupation" name="bot_occupation" placeholder="Creator, coach, artist, founder..." value="{{ settings.bot_occupation if settings else '' }}">
                            </div>
                            </div>
        </section>

        <section class="section-card">
          <div class="section-header">
            <h2>About Me</h2>
            <p>Write this the way you'd actually describe yourself.</p>
                            </div>
                             <div class="form-group" style="position: relative;">
            <label for="bot_personality">Bio / vibe</label>
            <textarea id="bot_personality" name="bot_personality" class="auto-resize" rows="4" maxlength="1000" placeholder="Let the AI know the story, the vibe, the energy it should keep.">{{ settings.bot_personality if settings and settings.bot_personality else '' }}</textarea>
            <div class="char-counter" data-for="bot_personality" style="position: absolute; bottom: 0.5rem; right: 1rem;">{{ settings.bot_personality|length if settings and settings.bot_personality else 0 }}/1000</div>
                             </div>
        </section>

        <section class="section-card">
          <div class="section-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
            <div style="flex: 1;">
              <h2>Conversation Examples</h2>
              <p style="margin-top: 0.5rem;">Fill in these general conversations by yourself to help train the AI to match your style.</p>
              <p style="margin-top: 0.5rem; font-size: 0.85rem; color: rgba(255, 255, 255, 0.6);">Feel free to use our templates to help you with the conversation examples.</p>
            </div>
            <button type="button" id="fill-templates-btn" class="btn-secondary" style="margin-top: 0; align-self: flex-start;">
              <i class="fas fa-fill"></i> Fill Templates
            </button>
          </div>
          <div class="conversation-examples">
            {% for example in conversation_templates %}
              <div class="conversation-example-card">
                <h3 class="conversation-title">{{ example.title }}</h3>
                <div class="dm-thread">
                  {% for exchange in example.exchanges %}
                    <div class="dm-message follower-message">
                      <div class="message-label">Follower</div>
                      {% set follower_key = example.key ~ '_' ~ exchange.bot_reply_key ~ '_follower' %}
                      {% set follower_value = '' %}
                      {% if settings and settings.conversation_samples and follower_key in settings.conversation_samples %}
                        {% set follower_value = settings.conversation_samples[follower_key] %}
                      {% else %}
                        {% set follower_value = exchange.follower_message %}
                      {% endif %}
                      <textarea id="follower_message_{{ follower_key }}" name="follower_message_{{ follower_key }}" class="auto-resize message-input" rows="2" maxlength="300" placeholder="Follower's message" style="background: rgba(255, 255, 255, 0.06); border-bottom-left-radius: 4px;">{{ follower_value }}</textarea>
                                 </div>
                    <div class="dm-message bot-message">
                      <div class="message-label">You</div>
                      {% set reply_key = example.key ~ '_' ~ exchange.bot_reply_key %}
                      {% set sample_value = '' %}
                      {% if settings and settings.conversation_samples and reply_key in settings.conversation_samples %}
                        {% set sample_value = settings.conversation_samples[reply_key] %}
                      {% endif %}
                      <textarea id="sample_reply_{{ reply_key }}" name="sample_reply_{{ reply_key }}" class="auto-resize message-input" rows="2" maxlength="200" placeholder="Type the reply you'd actually send.">{{ sample_value }}</textarea>
                      <div class="char-counter" data-for="sample_reply_{{ reply_key }}">{{ sample_value|length }}/200</div>
                             </div>
                  {% endfor %}
                                 </div>
                                 </div>
            {% endfor %}
                             </div>
        </section>

        <section class="section-card">
          <div class="section-header">
            <h2>Promotional Links</h2>
            <p>Drop anything the bot can plug when people ask (store, booking link, etc.).</p>
                             </div>
          <div id="links-list" class="item-collection">
            {% if settings and settings.links and settings.links|length > 0 %}
              {% for link in settings.links %}
                <div class="link-item item-row">
                             <div class="form-group">
                    <label>Link title</label>
                    <input type="text" name="link_titles[]" placeholder="Store, newsletter, booking..." value="{{ link.title or '' }}">
                             </div>
                             <div class="form-group">
                    <label>URL</label>
                    <input type="url" name="link_urls[]" placeholder="https://..." value="{{ link.url or '' }}">
                             </div>
                  <button type="button" class="remove-row-btn" data-action="remove-link">
                    <i class="fas fa-times"></i>
                                         </button>
                                     </div>
                                     {% endfor %}
                                 {% else %}
              <div class="link-item item-row">
                                     <div class="form-group">
                  <label>Link title</label>
                  <input type="text" name="link_titles[]" placeholder="Store, newsletter, booking...">
                                     </div>
                                     <div class="form-group">
                  <label>URL</label>
                  <input type="url" name="link_urls[]" placeholder="https://...">
                                     </div>
                <button type="button" class="remove-row-btn" data-action="remove-link">
                  <i class="fas fa-times"></i>
                </button>
                                 </div>
                                 {% endif %}
                             </div>
          <button type="button" id="add-link-btn" class="btn-ghost">+ Add Link</button>
        </section>

        <section class="section-card">
          <div class="section-header">
            <h2>Content Highlights</h2>
            <p>Give the bot context on what you post so it can reference it naturally.</p>
          </div>
                             <div class="form-group">
            <label for="instagram_url">Instagram profile link</label>
            <input type="url" id="instagram_url" name="instagram_url" placeholder="https://instagram.com/username" value="{{ settings.instagram_url if settings else '' }}">
                             </div>
          <div id="posts-list" class="item-collection">
            {% if settings and settings.posts and settings.posts|length > 0 %}
                                     {% for post in settings.posts %}
                <div class="post-item item-row">
                                         <div class="form-group">
                    <label>Post description</label>
                    <textarea name="post_descriptions[]" class="auto-resize" rows="2" maxlength="400" placeholder="How you'd describe the post.">{{ post.description or '' }}</textarea>
                                         </div>
                  <button type="button" class="remove-row-btn" data-action="remove-post">
                    <i class="fas fa-times"></i>
                  </button>
                                     </div>
                                     {% endfor %}
                                 {% else %}
              <div class="post-item item-row">
                                     <div class="form-group">
                  <label>Post description</label>
                  <textarea name="post_descriptions[]" class="auto-resize" rows="2" maxlength="400" placeholder="How you'd describe the post."></textarea>
                                     </div>
                <button type="button" class="remove-row-btn" data-action="remove-post">
                  <i class="fas fa-times"></i>
                </button>
                                 </div>
                                 {% endif %}
                             </div>
          <button type="button" id="add-post-btn" class="btn-ghost">+ Add Post</button>
        </section>

        <section class="section-card">
          <div class="section-header">
            <h2>Topics To Avoid</h2>
            <p>Hard no's, sensitive subjects, anything the bot should steer away from.</p>
                             </div>
                            <div class="form-group">
            <label for="avoid_topics">Keep away from...</label>
            <textarea id="avoid_topics" name="avoid_topics" class="auto-resize" rows="3" maxlength="500" placeholder="e.g. politics, pricing unless they ask, personal family details, NDAs">{{ settings.avoid_topics if settings and settings.avoid_topics else '' }}</textarea>
            <div class="char-counter" data-for="avoid_topics">{{ settings.avoid_topics|length if settings and settings.avoid_topics else 0 }}/500</div>
                            </div>
        </section>

            <div class="action-buttons">
                <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i>
            Save Settings
                </button>
          <button type="button" class="btn-secondary" onclick="resetSettings()">
            <i class="fas fa-undo"></i>
            Reset Form
                </button>
            </div>
        </form>
    {% endif %}
    </main>

    <script>
    (function () {
      const GRID_ID = 'interactiveGrid';
      const GRID_SIZE = 50;
      let gridEl = null;
      let ticking = false;
      const cellTimeouts = new Map();
      let mouseX = 0;
      let mouseY = 0;

      function createInteractiveGrid() {
        const grid = document.getElementById(GRID_ID);
        if (!grid) return;
        const cols = Math.ceil(window.innerWidth / GRID_SIZE) + 2;
        const rows = Math.ceil(window.innerHeight * 6 / GRID_SIZE); // 6x height for extended page coverage (matches 600% CSS height)
            grid.innerHTML = '';
        cellTimeouts.clear();
            
        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
            cell.style.left = `${(col - 1) * GRID_SIZE}px`;
            cell.style.top = `${(row - 1) * GRID_SIZE}px`;
                    grid.appendChild(cell);
                }
            }

        gridEl = grid;
        }
        
        function updateGridOnScroll() {
        if (!gridEl) return;
            if (!ticking) {
          requestAnimationFrame(() => {
            const scrollY = window.pageYOffset || window.scrollY || 0;
            gridEl.style.transform = `translateY(-${scrollY * 0.6}px)`;
                    ticking = false;
                });
                ticking = true;
            }
        }
        
      document.addEventListener('mousemove', event => {
        mouseX = event.clientX;
        mouseY = event.clientY;
      });

        function updateGridLighting() {
        if (!gridEl) {
          gridEl = document.getElementById(GRID_ID);
          if (!gridEl) {
            requestAnimationFrame(updateGridLighting);
            return;
          }
        }

        const cells = gridEl.querySelectorAll('.grid-cell');
            cells.forEach(cell => {
                const rect = cell.getBoundingClientRect();
          const isMouseOver =
            mouseX >= rect.left &&
                                  mouseX < rect.right && 
                                  mouseY >= rect.top && 
                                  mouseY < rect.bottom;
                
                if (isMouseOver) {
                    if (cellTimeouts.has(cell)) {
                        clearTimeout(cellTimeouts.get(cell));
                        cellTimeouts.delete(cell);
                    }
                    
                    cell.classList.add('active');
                    const timeoutId = setTimeout(() => {
                        cell.classList.remove('active');
                        cellTimeouts.delete(cell);
            }, 1200);
                    
                    cellTimeouts.set(cell, timeoutId);
                }
            });
            
        requestAnimationFrame(updateGridLighting);
        }
        
        function createAmbientLighting() {
        function lightRandomCell() {
          if (!gridEl) return;
          const cells = gridEl.querySelectorAll('.grid-cell');
          if (!cells.length) return;

          const cell = cells[Math.floor(Math.random() * cells.length)];
          cell.classList.add('active');
          setTimeout(() => cell.classList.remove('active'), Math.random() * 1500 + 600);
        }

        (function schedule() {
          lightRandomCell();
          setTimeout(schedule, Math.random() * 400 + 150);
        })();
      }

      function autoResize(field) {
        if (!field) return;
        field.style.height = 'auto';
        field.style.height = `${field.scrollHeight}px`;
      }

      function attachAutoResize() {
        document.querySelectorAll('textarea.auto-resize').forEach(field => {
          if (!field.dataset.autosizeReady) {
            field.dataset.autosizeReady = 'true';
            field.addEventListener('input', () => autoResize(field));
          }
          autoResize(field);
        });
      }

      function updateCounter(field, counter) {
        if (!field || !counter) return;
        const max = parseInt(field.getAttribute('maxlength'), 10);
        const length = field.value.trim().length;
        counter.textContent = max ? `${length}/${max}` : `${length}`;
        if (max) {
          const ratio = length / max;
          counter.classList.toggle('near-limit', ratio >= 0.9);
        }
      }

      function attachCounters() {
        document.querySelectorAll('.char-counter').forEach(counter => {
          const targetId = counter.dataset.for;
          const field = document.getElementById(targetId);
          if (!field) return;
          if (!field.dataset.counterReady) {
            field.dataset.counterReady = 'true';
            field.addEventListener('input', () => updateCounter(field, counter));
          }
          updateCounter(field, counter);
        });
      }

      function setupLinkControls() {
        const list = document.getElementById('links-list');
        const addBtn = document.getElementById('add-link-btn');
        if (!list || !addBtn) return;

        addBtn.addEventListener('click', () => {
          const item = document.createElement('div');
          item.className = 'link-item item-row';
          item.innerHTML = `
            <div class="form-group">
              <label>Link title</label>
              <input type="text" name="link_titles[]" placeholder="Store, newsletter, booking...">
            </div>
            <div class="form-group">
              <label>URL</label>
              <input type="url" name="link_urls[]" placeholder="https://...">
            </div>
            <button type="button" class="remove-row-btn" data-action="remove-link">
              <i class="fas fa-times"></i>
            </button>
          `;
          list.appendChild(item);
        });

        list.addEventListener('click', event => {
          const button = event.target.closest('[data-action="remove-link"]');
          if (!button) return;
          const item = button.closest('.link-item');
          if (!item) return;
          if (list.children.length === 1) {
            item.querySelectorAll('input').forEach(input => (input.value = ''));
                         return;
                     }
          item.remove();
        });
      }

      function setupPostControls() {
        const list = document.getElementById('posts-list');
        const addBtn = document.getElementById('add-post-btn');
        if (!list || !addBtn) return;

        addBtn.addEventListener('click', () => {
          const item = document.createElement('div');
          item.className = 'post-item item-row';
          item.innerHTML = `
            <div class="form-group">
              <label>Post description</label>
              <textarea name="post_descriptions[]" class="auto-resize" rows="2" maxlength="400" placeholder="How you'd describe the post."></textarea>
            </div>
            <button type="button" class="remove-row-btn" data-action="remove-post">
              <i class="fas fa-times"></i>
            </button>
          `;
          list.appendChild(item);
          attachAutoResize();
          attachCounters();
        });

        list.addEventListener('click', event => {
          const button = event.target.closest('[data-action="remove-post"]');
          if (!button) return;
          const item = button.closest('.post-item');
          if (!item) return;
          if (list.children.length === 1) {
            const textarea = item.querySelector('textarea');
            if (textarea) {
              textarea.value = '';
              autoResize(textarea);
              attachCounters();
            }
                         return;
                     }
          item.remove();
        });
      }

      function fillTemplates() {
        const conversationTemplates = {{ conversation_templates|tojson }};
        conversationTemplates.forEach(example => {
          example.exchanges.forEach((exchange, index) => {
            const followerKey = `${example.key}_${exchange.bot_reply_key}_follower`;
            const followerInput = document.getElementById(`follower_message_${followerKey}`);
            if (followerInput && !followerInput.value.trim()) {
              followerInput.value = exchange.follower_message;
              autoResize(followerInput);
            }
          });
        });
      }

      document.getElementById('fill-templates-btn')?.addEventListener('click', fillTemplates);

      window.resetSettings = function resetSettings() {
        const form = document.getElementById('botSettingsForm');
        if (!form) return;
        if (!confirm('Reset all fields back to the saved version?')) return;
        form.reset();
        requestAnimationFrame(() => {
          attachAutoResize();
          attachCounters();
        });
      };

      document.addEventListener('DOMContentLoaded', () => {
        attachAutoResize();
        attachCounters();
        setupLinkControls();
        setupPostControls();
        
        // Attach auto-resize to follower message textareas
        document.querySelectorAll('.follower-message .message-input').forEach(field => {
          if (!field.dataset.autosizeReady) {
            field.dataset.autosizeReady = 'true';
            field.addEventListener('input', () => autoResize(field));
            autoResize(field);
          }
        });
      });

      window.addEventListener('load', () => {
        window.scrollTo(0, 0);
        createInteractiveGrid();
        updateGridOnScroll();
        updateGridLighting();
        setTimeout(createAmbientLighting, 800);
      });

      window.addEventListener('resize', () => {
        createInteractiveGrid();
        updateGridOnScroll();
      });

      window.addEventListener('scroll', updateGridOnScroll, { passive: true });
    })();
    </script>
</body>
</html>
