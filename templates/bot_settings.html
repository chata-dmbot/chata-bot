{% extends "base.html" %}

{% block title %}AI Settings - CHATA{% endblock %}

{% block page_styles %}
/* --- Additional CSS variables --- */
:root {
    --glass-border: rgba(255, 255, 255, 0.08);
    --glass-bg: rgba(15, 20, 35, 0.55);
    --glass-bg-strong: rgba(18, 25, 46, 0.75);
}

/* --- Body overrides (bot_settings uses different spacing/weight) --- */
body {
    letter-spacing: 0.06em;
    font-weight: normal;
    text-transform: none;
}

body::before {
    inset: 0;
    width: auto;
    height: auto;
    background: rgba(0, 0, 0, 0.12);
    backdrop-filter: blur(2px);
}

a {
    color: inherit;
    text-decoration: none;
}

/* --- Grid overrides --- */
.interactive-grid {
    overflow: hidden;
    transition: transform 0.3s ease;
    pointer-events: none;
}

.grid-cell {
    border-color: rgba(51, 102, 255, 0.08);
    transition: background 0.6s ease, border-color 0.6s ease, box-shadow 0.6s ease, transform 0.6s ease;
    pointer-events: none;
}

.grid-cell:hover {
    background: transparent;
    border-color: rgba(51, 102, 255, 0.08);
    box-shadow: none;
    transform: none;
}

.grid-cell.active {
    background: rgba(51, 102, 255, 0.15);
    border-color: rgba(51, 102, 255, 0.45);
    box-shadow: 0 0 25px rgba(51, 102, 255, 0.4);
    transform: scale(1.03);
}


/* --- Hero --- */
.bot-settings-hero {
    padding-top: 140px;
    padding-bottom: 48px;
    text-align: center;
    position: relative;
    z-index: 5;
}

.bot-settings-hero h1 {
    font-size: 3.5rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    text-transform: uppercase;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #fff, #ccc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.bot-settings-hero p {
    max-width: 560px;
    margin: 0 auto;
    font-size: 1.2rem;
    font-weight: 300;
    letter-spacing: 0.05em;
    color: #888;
    text-transform: none;
}

/* --- Content --- */
.bot-settings-content {
    max-width: 1180px;
    margin: 0 auto 96px;
    padding: 0 1.5rem 2rem;
    position: relative;
    z-index: 5;
}

/* --- Alert overrides --- */
.alert {
    max-width: 1180px;
    margin: 0 auto 1.5rem;
    padding: 0.9rem 1.2rem;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.12);
    border: 1px solid rgba(255, 255, 255, 0.18);
    font-size: 0.85rem;
    letter-spacing: 0.12em;
    text-transform: none;
    text-align: left;
}

.alert-success {
    background: rgba(51, 102, 255, 0.08);
    border-color: rgba(51, 102, 255, 0.4);
    color: #cdd9ff;
}

.alert-error,
.alert-warning {
    background: rgba(255, 107, 107, 0.08);
    border-color: rgba(255, 107, 107, 0.35);
    color: #ffd6d6;
}

/* --- Connection Banner --- */
.connection-banner {
    margin-bottom: 1.5rem;
    padding: 1rem 1.5rem;
    border-radius: 16px;
    background: var(--glass-bg-strong);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(18px);
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    align-items: center;
    letter-spacing: 0.1em;
    text-transform: none;
}

.connection-banner strong {
    font-weight: 600;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.8);
}

.connection-banner span {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.7);
}

/* --- Settings Form --- */
.settings-form {
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
}

/* --- Section Cards --- */
.section-card {
    padding: 2rem;
    border-radius: 24px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: 0 18px 60px rgba(0, 0, 0, 0.55);
    backdrop-filter: blur(16px);
}

.section-header {
    margin-bottom: 1.5rem;
}

.section-header h2 {
    margin: 0 0 0.6rem;
    font-size: 1.1rem;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    font-weight: 600;
}

.section-header p {
    margin: 0;
    font-size: 0.9rem;
    letter-spacing: 0.08em;
    color: rgba(255, 255, 255, 0.65);
    text-transform: none;
}

/* --- Form Elements --- */
.form-grid {
    display: grid;
    gap: 1.25rem 1.5rem;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.45rem;
    text-transform: none;
    letter-spacing: 0.05em;
}

.form-group label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.24em;
    color: rgba(255, 255, 255, 0.72);
}

.form-group input,
.form-group textarea {
    width: 100%;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.05);
    border-radius: 14px;
    padding: 0.85rem 1rem;
    color: #fff;
    font-size: 0.92rem;
    font-weight: 400;
    letter-spacing: 0.05em;
    resize: none;
    transition: border 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
}

.form-group input:focus,
.form-group textarea:focus {
    border-color: rgba(51, 102, 255, 0.7);
    box-shadow: 0 0 0 3px rgba(51, 102, 255, 0.15);
    background: rgba(255, 255, 255, 0.08);
    outline: none;
}

input::placeholder,
textarea::placeholder {
    color: rgba(255, 255, 255, 0.45);
}

/* --- Character Counter --- */
.char-counter {
    font-size: 0.7rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.35);
    align-self: flex-end;
}

.char-counter.near-limit {
    color: rgba(255, 125, 125, 0.8);
}

/* --- Conversation Examples --- */
.conversation-examples {
    display: grid;
    gap: 2rem;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
}

.conversation-example-card {
    border-radius: 18px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: rgba(10, 15, 32, 0.7);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    transition: border-color 0.3s ease, transform 0.3s ease;
}

.conversation-example-card:hover {
    border-color: rgba(51, 102, 255, 0.3);
    transform: translateY(-2px);
}

.conversation-title {
    margin: 0 0 1rem;
    font-size: 1rem;
    font-weight: 600;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.85);
}

/* --- DM Thread --- */
.dm-thread {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.dm-message {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    max-width: 100%;
}

.dm-message.follower-message {
    align-self: flex-start;
    align-items: flex-start;
}

.dm-message.bot-message {
    align-self: flex-end;
    align-items: flex-end;
}

.message-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 0.2rem;
}

.message-content {
    padding: 0.75rem 1rem;
    border-radius: 18px;
    font-size: 0.9rem;
    letter-spacing: 0.05em;
    color: rgba(255, 255, 255, 0.9);
    text-transform: none;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.1);
    word-wrap: break-word;
}

.dm-message.follower-message .message-content {
    border-bottom-left-radius: 4px;
    background: rgba(255, 255, 255, 0.06);
}

.dm-message.follower-message .message-input {
    width: 100%;
    border-radius: 18px;
    border-bottom-left-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.06);
    color: #fff;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    letter-spacing: 0.05em;
    resize: none;
    transition: border 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    font-family: inherit;
    min-height: 40px;
}

.dm-message.follower-message .message-input:focus {
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.08);
    outline: none;
}

.dm-message.bot-message .message-input {
    width: 100%;
    border-radius: 18px;
    border-bottom-right-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(51, 102, 255, 0.15);
    color: #fff;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    letter-spacing: 0.05em;
    resize: none;
    transition: border 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    font-family: inherit;
    min-height: 40px;
}

.dm-message.bot-message .message-input:focus {
    border-color: rgba(51, 102, 255, 0.7);
    box-shadow: 0 0 0 3px rgba(51, 102, 255, 0.15);
    background: rgba(51, 102, 255, 0.2);
    outline: none;
}

.dm-message.bot-message .char-counter {
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.35);
    align-self: flex-end;
    margin-top: 0.2rem;
}

.conversation-input {
    min-height: 110px;
}

/* --- Scrollbar styling for textareas --- */
textarea::-webkit-scrollbar {
    width: 6px;
}

textarea::-webkit-scrollbar-track {
    background: transparent;
}

textarea::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
}

textarea::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
}

textarea {
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}

/* --- Item Collection --- */
.item-collection {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.item-row {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    align-items: start;
    padding: 1.25rem;
    border-radius: 16px;
    background: rgba(6, 12, 26, 0.65);
    border: 1px solid rgba(255, 255, 255, 0.08);
    position: relative;
}

.remove-row-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.16);
    background: transparent;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}

.remove-row-btn:hover {
    background: rgba(255, 99, 99, 0.18);
    border-color: rgba(255, 99, 99, 0.4);
    color: #ff9b9b;
}

/* --- Buttons --- */
.btn-primary,
.btn-secondary,
.btn-ghost {
    display: inline-flex;
    align-items: center;
    gap: 0.6rem;
    border-radius: 999px;
    padding: 0.9rem 1.8rem;
    border: none;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.24em;
    text-transform: uppercase;
    transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
}

.btn-primary {
    background: linear-gradient(135deg, var(--chata-blue) 0%, var(--chata-blue-light) 100%);
    color: #fff;
    box-shadow: 0 16px 35px rgba(51, 102, 255, 0.34);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 40px rgba(51, 102, 255, 0.45);
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.08);
    color: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.16);
}

.btn-secondary:hover {
    transform: translateY(-2px);
    background: rgba(255, 255, 255, 0.12);
}

.btn-ghost {
    background: rgba(51, 102, 255, 0.12);
    color: rgba(187, 204, 255, 0.9);
    border: 1px dashed rgba(51, 102, 255, 0.35);
    font-size: 0.75rem;
    padding: 0.75rem 1.5rem;
    justify-content: center;
}

.btn-ghost:hover {
    background: rgba(51, 102, 255, 0.2);
    border-style: solid;
}

/* --- Action Buttons --- */
.action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1rem;
}

/* --- Empty State --- */
.empty-state {
    padding: 3rem;
    border-radius: 24px;
    background: var(--glass-bg);
    border: 1px dashed rgba(255, 255, 255, 0.12);
    text-align: center;
    letter-spacing: 0.08em;
    text-transform: none;
}

.empty-state h2 {
    margin: 0 0 1rem;
    font-size: 1rem;
    letter-spacing: 0.24em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.85);
}

.empty-state p {
    margin: 0 0 1.5rem;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
}

.empty-state a {
    display: inline-block;
    padding: 0.85rem 1.7rem;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.16);
    background: rgba(255, 255, 255, 0.08);
    font-size: 0.75rem;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.78);
    transition: background 0.25s ease, transform 0.25s ease;
}

.empty-state a:hover {
    background: rgba(255, 255, 255, 0.14);
    transform: translateY(-2px);
}

/* --- Toast Notification --- */
.toast {
    position: fixed;
    right: 2rem;
    top: 100px;
    background: rgba(51, 102, 255, 0.15);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(51, 102, 255, 0.3);
    border-radius: 16px;
    padding: 1.5rem;
    max-width: 350px;
    z-index: 1000;
    opacity: 0;
    transform: translateX(400px);
    transition: all 0.4s ease;
    box-shadow: 0 8px 32px rgba(51, 102, 255, 0.2);
}

.toast.show {
    opacity: 1;
    transform: translateX(0);
}

.toast-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
}

.toast-header h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--chata-blue);
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.toast-body {
    font-size: 0.9rem;
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.9);
    text-transform: none;
    letter-spacing: normal;
}

.toast-close {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    font-size: 1.2rem;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.toast-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
}

/* --- Reset Form Modal --- */
.reset-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
}

.reset-modal.show {
    display: flex;
}

.reset-modal-content {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    position: relative;
}

.reset-modal-content h3 {
    color: #ef4444;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    text-transform: none;
}

.reset-modal-content p {
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.6;
    margin-bottom: 1.5rem;
    text-transform: none;
}

.reset-modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.btn-danger-modal {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    border: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-danger-modal:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
}

.btn-cancel-modal {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-cancel-modal:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* --- Responsive 960px --- */
@media (max-width: 960px) {
    .nav-links {
        display: none;
    }

    .nav-actions {
        position: static;
        margin-left: auto;
    }

    .bot-settings-hero h1 {
        font-size: 2.6rem;
        letter-spacing: 0.32em;
    }

    .section-card {
        padding: 1.5rem;
    }
}

/* --- Responsive 640px --- */
@media (max-width: 640px) {
    .toast {
        right: 1rem;
        left: 1rem;
        max-width: none;
        top: 80px;
    }

    .bot-settings-hero {
        padding-top: 120px;
    }

    .bot-settings-hero h1 {
        font-size: 2.2rem;
        letter-spacing: 0.28em;
    }

    .connection-banner {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.6rem;
    }

    .item-row {
        grid-template-columns: 1fr;
        padding-right: 3rem;
    }

    .remove-row-btn {
        top: 0.4rem;
        right: 0.4rem;
    }

    .action-buttons {
        justify-content: center;
    }
}
{% endblock %}

{% block navigation %}
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 w-full z-50 glass-nav navigation">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
            <div class="flex items-center h-16">
                <!-- Logo - Left aligned -->
                <div class="absolute left-0">
                    <a href="{{ url_for('pages.home') }}" class="text-3xl font-bold logo-blue pl-4">
                        CHATA
                    </a>
                </div>
      
                <!-- Desktop Navigation - Centered -->
                <div class="hidden md:block absolute left-1/2 transform -translate-x-1/2">
                    <div class="flex items-center space-x-8">
                        <a href="{{ url_for('dashboard_bp.dashboard') }}" class="nav-item text-white hover:text-blue-400 px-3 py-2 text-sm font-medium">DASHBOARD</a>
                        <a href="{{ url_for('pages.home') }}" class="nav-item text-white hover:text-blue-400 px-3 py-2 text-sm font-medium">HOME</a>
                    </div>
                </div>
  
                <!-- CTA Buttons - Right aligned -->
                <div class="hidden md:block absolute right-0">
                    <div class="flex items-center space-x-4 pr-4">
                        <a href="{{ url_for('pages.support') }}" class="text-white hover:text-blue-400 px-3 py-2 text-sm font-medium">SUPPORT</a>
                        <a href="{{ url_for('dashboard_bp.account_settings') }}" class="text-white hover:text-blue-400 px-3 py-2 text-sm font-medium">SETTINGS</a>
                        <a href="{{ url_for('auth.logout') }}" class="cta-button text-white px-6 py-2 rounded-full text-sm font-medium">LOGOUT</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
{% endblock %}

{% block flash_messages %}{% endblock %}

{% block content %}
<section class="bot-settings-hero">
    <div>
        <h1>AI Settings</h1>
        <p>Give your AI the personality that best describes you.</p>
    </div>
</section>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="bot-settings-content" style="z-index: 20; position: relative;">
        {% for category, message in messages %}
            <div class="alert alert-{{ 'error' if category in ['error', 'danger', 'warning'] else category }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}
{% endwith %}

<main class="bot-settings-content">
{% if not connections %}
    <div class="empty-state">
        <h2>NO INSTAGRAM CONNECTION</h2>
        <p>Hook up your Instagram account first so we know who we're mimicking.</p>
        <a href="{{ url_for('dashboard_bp.dashboard') }}">GO TO DASHBOARD</a>
    </div>
{% else %}
    <form id="botSettingsForm" method="POST" class="settings-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="connection_id" value="{{ selected_connection_id }}">

        <section class="section-card">
            <div class="section-header">
                <h2>Essentials</h2>
                <p>Baseline details your bot will casually reuse in conversation.</p>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="bot_name">Name</label>
                    <input type="text" id="bot_name" name="bot_name" placeholder="What do people call you?" value="{{ settings.bot_name if settings else '' }}">
                </div>
                <div class="form-group">
                    <label for="bot_age">Age</label>
                    <input type="text" id="bot_age" name="bot_age" placeholder="Optional, keep it human." value="{{ settings.bot_age if settings else '' }}">
                </div>
                <div class="form-group">
                    <label for="bot_location">Location</label>
                    <input type="text" id="bot_location" name="bot_location" placeholder="Where are you based?" value="{{ settings.bot_location if settings else '' }}">
                </div>
                <div class="form-group">
                    <label for="bot_occupation">What you do</label>
                    <input type="text" id="bot_occupation" name="bot_occupation" placeholder="Creator, coach, artist, founder..." value="{{ settings.bot_occupation if settings else '' }}">
                </div>
            </div>
        </section>

        <section class="section-card">
            <div class="section-header">
                <h2>About Me</h2>
                <p>Write this the way you'd actually describe yourself.</p>
            </div>
            <div class="form-group" style="position: relative;">
                <label for="bot_personality">Bio / vibe</label>
                <textarea id="bot_personality" name="bot_personality" class="auto-resize" rows="4" maxlength="1000" placeholder="Let the AI know the story, the vibe, the energy it should keep.">{{ settings.bot_personality if settings and settings.bot_personality else '' }}</textarea>
                <div class="char-counter" data-for="bot_personality" style="position: absolute; bottom: 0.5rem; right: 1rem;">{{ settings.bot_personality|length if settings and settings.bot_personality else 0 }}/1000</div>
            </div>
        </section>

        <section class="section-card">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                <div style="flex: 1;">
                    <h2>Conversation Examples</h2>
                    <p style="margin-top: 0.5rem;">Fill in these general conversations by yourself to help train the AI to match your style.</p>
                    <p style="margin-top: 0.5rem; font-size: 0.85rem; color: rgba(255, 255, 255, 0.6);">Feel free to use our templates to help you with the conversation examples.</p>
                </div>
                <button type="button" id="fill-templates-btn" class="btn-secondary" style="margin-top: 0; align-self: flex-start;">
                    <i class="fas fa-fill"></i> Fill Templates
                </button>
            </div>
            <div class="conversation-examples">
                {% for example in conversation_templates %}
                <div class="conversation-example-card">
                    <h3 class="conversation-title">{{ example.title }}</h3>
                    <div class="dm-thread">
                        {% for exchange in example.exchanges %}
                        <div class="dm-message follower-message">
                            <div class="message-label">Follower</div>
                            {% set follower_key = example.key ~ '_' ~ exchange.bot_reply_key ~ '_follower' %}
                            {% set follower_value = '' %}
                            {% if settings and settings.conversation_samples and follower_key in settings.conversation_samples %}
                                {% set follower_value = settings.conversation_samples[follower_key] %}
                            {% endif %}
                            <textarea id="follower_message_{{ follower_key }}" name="follower_message_{{ follower_key }}" class="auto-resize message-input" rows="1" maxlength="300" placeholder="Follower's message" style="background: rgba(255, 255, 255, 0.06); border-bottom-left-radius: 4px;">{{ follower_value }}</textarea>
                        </div>
                        <div class="dm-message bot-message">
                            <div class="message-label">You</div>
                            {% set reply_key = example.key ~ '_' ~ exchange.bot_reply_key %}
                            {% set sample_value = '' %}
                            {% if settings and settings.conversation_samples and reply_key in settings.conversation_samples %}
                                {% set sample_value = settings.conversation_samples[reply_key] %}
                            {% endif %}
                            <textarea id="sample_reply_{{ reply_key }}" name="sample_reply_{{ reply_key }}" class="auto-resize message-input" rows="1" maxlength="200" placeholder="Type the reply you'd actually send.">{{ sample_value }}</textarea>
                            <div class="char-counter" data-for="sample_reply_{{ reply_key }}">{{ sample_value|length }}/200</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <section class="section-card">
            <div class="section-header">
                <h2>Promotional Links</h2>
                <p>Drop anything the AI can plug when people ask (store, booking link, etc.).</p>
            </div>
            <div id="links-list" class="item-collection">
                {% if settings and settings.links and settings.links|length > 0 %}
                {% for link in settings.links %}
                <div class="link-item item-row">
                    <div class="form-group">
                        <label>Link title</label>
                        <input type="text" name="link_titles[]" placeholder="Store, newsletter, booking..." value="{{ link.title or '' }}">
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" name="link_urls[]" placeholder="https://..." value="{{ link.url or '' }}">
                    </div>
                    <button type="button" class="remove-row-btn" data-action="remove-link">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {% endfor %}
                {% else %}
                <div class="link-item item-row">
                    <div class="form-group">
                        <label>Link title</label>
                        <input type="text" name="link_titles[]" placeholder="Store, newsletter, booking...">
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" name="link_urls[]" placeholder="https://...">
                    </div>
                    <button type="button" class="remove-row-btn" data-action="remove-link">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {% endif %}
            </div>
            <button type="button" id="add-link-btn" class="btn-ghost">+ Add Link</button>
        </section>

        <section class="section-card">
            <div class="section-header">
                <h2>Content Highlights</h2>
                <p>Give the AI context on what you post so it can reference it naturally.</p>
            </div>
            <div class="form-group">
                <label for="instagram_url">Instagram profile link</label>
                <input type="url" id="instagram_url" name="instagram_url" placeholder="https://instagram.com/username" value="{{ settings.instagram_url if settings else '' }}">
            </div>
            <div id="posts-list" class="item-collection">
                {% if settings and settings.posts and settings.posts|length > 0 %}
                {% for post in settings.posts %}
                <div class="post-item item-row">
                    <div class="form-group">
                        <label>Post description</label>
                        <textarea name="post_descriptions[]" class="auto-resize" rows="2" maxlength="400" placeholder="How you'd describe the post.">{{ post.description or '' }}</textarea>
                    </div>
                    <button type="button" class="remove-row-btn" data-action="remove-post">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {% endfor %}
                {% else %}
                <div class="post-item item-row">
                    <div class="form-group">
                        <label>Post description</label>
                        <textarea name="post_descriptions[]" class="auto-resize" rows="2" maxlength="400" placeholder="How you'd describe the post."></textarea>
                    </div>
                    <button type="button" class="remove-row-btn" data-action="remove-post">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {% endif %}
            </div>
            <button type="button" id="add-post-btn" class="btn-ghost">+ Add Post</button>
        </section>

        <section class="section-card">
            <div class="section-header">
                <h2>Frequently Asked Questions</h2>
                <p>Add questions you frequently receive and your typical replies to help the AI respond accurately.</p>
            </div>
            <div id="faqs-list" class="item-collection">
                {% if settings and settings.faqs and settings.faqs|length > 0 %}
                {% for faq in settings.faqs %}
                <div class="faq-item item-row" style="grid-template-columns: 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Question</label>
                        <textarea name="faq_questions[]" class="auto-resize" rows="1" maxlength="300" placeholder="Question you frequently receive">{{ faq.question or '' }}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Your Reply</label>
                        <textarea name="faq_replies[]" class="auto-resize" rows="1" maxlength="300" placeholder="Your typical reply to this question">{{ faq.reply or '' }}</textarea>
                    </div>
                    <button type="button" class="remove-row-btn" data-action="remove-faq">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {% endfor %}
                {% else %}
                <div class="faq-item item-row" style="grid-template-columns: 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Question</label>
                        <textarea name="faq_questions[]" class="auto-resize" rows="1" maxlength="300" placeholder="Question you frequently receive"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Your Reply</label>
                        <textarea name="faq_replies[]" class="auto-resize" rows="1" maxlength="300" placeholder="Your typical reply to this question"></textarea>
                    </div>
                    <button type="button" class="remove-row-btn" data-action="remove-faq">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {% endif %}
            </div>
            <button type="button" id="add-faq-btn" class="btn-ghost">+ Add FAQ</button>
        </section>

        <section class="section-card">
            <div class="section-header">
                <h2>Topics To Avoid</h2>
                <p>Hard no's, sensitive subjects, anything the AI should steer away from.</p>
            </div>
            <div class="form-group">
                <label for="avoid_topics">Keep away from...</label>
                <textarea id="avoid_topics" name="avoid_topics" class="auto-resize" rows="3" maxlength="500" placeholder="e.g. politics, pricing unless they ask, personal family details, NDAs">{{ settings.avoid_topics if settings and settings.avoid_topics else '' }}</textarea>
                <div class="char-counter" data-for="avoid_topics">{{ settings.avoid_topics|length if settings and settings.avoid_topics else 0 }}/500</div>
            </div>
        </section>

        <section class="section-card">
            <div class="section-header">
                <h2>Users To Avoid</h2>
                <p>Block specific Instagram users from receiving automatic replies. Enter one username per line (with or without @ symbol).</p>
            </div>
            <div class="form-group">
                <label for="blocked_users">Blocked Instagram Usernames</label>
                <textarea id="blocked_users" name="blocked_users" class="auto-resize" rows="5" placeholder="e.g.&#10;@username1&#10;username2&#10;@spammer123">{{ '\n'.join(settings.get('blocked_users', [])) if settings and settings.get('blocked_users') else '' }}</textarea>
                <div class="form-hint">
                    <i class="fas fa-info-circle"></i>
                    The bot will not respond to messages from these users. Enter usernames one per line. The @ symbol is optional.
                </div>
            </div>
        </section>

        <div class="action-buttons">
            <button type="submit" class="btn-primary">
                <i class="fas fa-save"></i>
                Save Settings
            </button>
            <button type="button" class="btn-secondary" onclick="resetSettings()">
                <i class="fas fa-undo"></i>
                Reset Form
            </button>
        </div>
    </form>
{% endif %}
</main>

<!-- Toast Notification -->
<div id="help-toast" class="toast">
    <button class="toast-close" id="toast-close-btn">
        <i class="fas fa-times"></i>
    </button>
    <div class="toast-header">
        <i class="fas fa-info-circle" style="color: var(--chata-blue);"></i>
        <h3>Hey from Chata</h3>
    </div>
    <div class="toast-body">
        You don't need to fill in every field here. Just provide as much information as you think is relevant for your AI. Remember: the more information you provide, the more accurate your AI will be. Take your time, but don't stress if not everything is filled in.
    </div>
</div>

<!-- Reset Form Modal -->
<div id="resetModal" class="reset-modal">
    <div class="reset-modal-content">
        <h3><i class="fas fa-exclamation-triangle"></i> Reset Form</h3>
        <p><strong>Are you sure you want to reset all fields?</strong></p>
        <p>This will clear all unsaved changes and restore the form to the last saved version. This action cannot be undone.</p>
        <div class="reset-modal-actions">
            <button class="btn-cancel-modal" onclick="closeResetModal()">Cancel</button>
            <button class="btn-danger-modal" onclick="confirmReset()">
                <i class="fas fa-undo"></i> Reset Form
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
    /* --- Auto-resize textareas --- */
    function autoResize(field) {
        if (!field) return;
        field.style.height = 'auto';
        field.style.height = field.scrollHeight + 'px';
    }

    function attachAutoResize() {
        document.querySelectorAll('textarea.auto-resize').forEach(function (field) {
            if (!field.dataset.autosizeReady) {
                field.dataset.autosizeReady = 'true';
                field.addEventListener('input', function () { autoResize(field); });
            }
            autoResize(field);
        });
    }

    /* --- Character counters --- */
    function updateCounter(field, counter) {
        if (!field || !counter) return;
        var max = parseInt(field.getAttribute('maxlength'), 10);
        var length = field.value.trim().length;
        counter.textContent = max ? length + '/' + max : '' + length;
        if (max) {
            var ratio = length / max;
            counter.classList.toggle('near-limit', ratio >= 0.9);
        }
    }

    function attachCounters() {
        document.querySelectorAll('.char-counter').forEach(function (counter) {
            var targetId = counter.dataset.for;
            var field = document.getElementById(targetId);
            if (!field) return;
            if (!field.dataset.counterReady) {
                field.dataset.counterReady = 'true';
                field.addEventListener('input', function () { updateCounter(field, counter); });
            }
            updateCounter(field, counter);
        });
    }

    /* --- Link controls --- */
    function setupLinkControls() {
        var list = document.getElementById('links-list');
        var addBtn = document.getElementById('add-link-btn');
        if (!list || !addBtn) return;

        addBtn.addEventListener('click', function () {
            var item = document.createElement('div');
            item.className = 'link-item item-row';
            item.innerHTML =
                '<div class="form-group">' +
                    '<label>Link title</label>' +
                    '<input type="text" name="link_titles[]" placeholder="Store, newsletter, booking...">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label>URL</label>' +
                    '<input type="url" name="link_urls[]" placeholder="https://...">' +
                '</div>' +
                '<button type="button" class="remove-row-btn" data-action="remove-link">' +
                    '<i class="fas fa-times"></i>' +
                '</button>';
            list.appendChild(item);
        });

        list.addEventListener('click', function (event) {
            var button = event.target.closest('[data-action="remove-link"]');
            if (!button) return;
            var item = button.closest('.link-item');
            if (!item) return;
            if (list.children.length === 1) {
                item.querySelectorAll('input').forEach(function (input) { input.value = ''; });
                return;
            }
            item.remove();
        });
    }

    /* --- Post controls --- */
    function setupPostControls() {
        var list = document.getElementById('posts-list');
        var addBtn = document.getElementById('add-post-btn');
        if (!list || !addBtn) return;

        addBtn.addEventListener('click', function () {
            var item = document.createElement('div');
            item.className = 'post-item item-row';
            item.innerHTML =
                '<div class="form-group">' +
                    '<label>Post description</label>' +
                    '<textarea name="post_descriptions[]" class="auto-resize" rows="2" maxlength="400" placeholder="How you\'d describe the post."></textarea>' +
                '</div>' +
                '<button type="button" class="remove-row-btn" data-action="remove-post">' +
                    '<i class="fas fa-times"></i>' +
                '</button>';
            list.appendChild(item);
            attachAutoResize();
            attachCounters();
        });

        list.addEventListener('click', function (event) {
            var button = event.target.closest('[data-action="remove-post"]');
            if (!button) return;
            var item = button.closest('.post-item');
            if (!item) return;
            if (list.children.length === 1) {
                var textarea = item.querySelector('textarea');
                if (textarea) {
                    textarea.value = '';
                    autoResize(textarea);
                    attachCounters();
                }
                return;
            }
            item.remove();
        });
    }

    /* --- FAQ controls --- */
    function setupFAQControls() {
        var list = document.getElementById('faqs-list');
        var addBtn = document.getElementById('add-faq-btn');
        if (!list || !addBtn) return;

        addBtn.addEventListener('click', function () {
            var item = document.createElement('div');
            item.className = 'faq-item item-row';
            item.style.cssText = 'grid-template-columns: 1fr; gap: 1rem;';
            item.innerHTML =
                '<div class="form-group">' +
                    '<label>Question</label>' +
                    '<textarea name="faq_questions[]" class="auto-resize" rows="1" maxlength="300" placeholder="Question you frequently receive"></textarea>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label>Your Reply</label>' +
                    '<textarea name="faq_replies[]" class="auto-resize" rows="1" maxlength="300" placeholder="Your typical reply to this question"></textarea>' +
                '</div>' +
                '<button type="button" class="remove-row-btn" data-action="remove-faq">' +
                    '<i class="fas fa-times"></i>' +
                '</button>';
            list.appendChild(item);
            attachAutoResize();
            attachCounters();
        });

        list.addEventListener('click', function (event) {
            var button = event.target.closest('[data-action="remove-faq"]');
            if (!button) return;
            var item = button.closest('.faq-item');
            if (!item) return;
            if (list.children.length === 1) {
                item.querySelectorAll('textarea').forEach(function (textarea) {
                    textarea.value = '';
                    autoResize(textarea);
                });
                attachCounters();
                return;
            }
            item.remove();
        });
    }

    /* --- Toast notification --- */
    function showToast() {
        var toast = document.getElementById('help-toast');
        if (!toast) return;
        setTimeout(function () { toast.classList.add('show'); }, 1000);
    }

    function closeToast() {
        var toast = document.getElementById('help-toast');
        if (toast) toast.classList.remove('show');
    }
    window.closeToast = closeToast;

    /* --- Fill conversation templates --- */
    function fillTemplates() {
        var conversationTemplates = {{ conversation_templates|tojson }};
        conversationTemplates.forEach(function (example) {
            example.exchanges.forEach(function (exchange) {
                var followerKey = example.key + '_' + exchange.bot_reply_key + '_follower';
                var followerInput = document.getElementById('follower_message_' + followerKey);
                if (followerInput && !followerInput.value.trim()) {
                    followerInput.value = exchange.follower_message;
                    autoResize(followerInput);
                }
            });
        });
    }

    var fillBtn = document.getElementById('fill-templates-btn');
    if (fillBtn) fillBtn.addEventListener('click', fillTemplates);

    /* --- Reset settings --- */
    window.resetSettings = function () {
        var modal = document.getElementById('resetModal');
        if (modal) modal.classList.add('show');
    };

    window.confirmReset = function () {
        var form = document.getElementById('botSettingsForm');
        if (!form) return;
        form.reset();
        requestAnimationFrame(function () {
            attachAutoResize();
            attachCounters();
        });
        window.closeResetModal();
    };

    window.closeResetModal = function () {
        var modal = document.getElementById('resetModal');
        if (modal) modal.classList.remove('show');
    };

    /* --- Show overlay on Save Settings --- */
    function setupFormOverlay() {
        var form = document.getElementById('botSettingsForm');
        if (!form) return;
        form.addEventListener('submit', function () {
            var overlay = document.getElementById('pageLoadOverlay');
            if (overlay) {
                overlay.classList.remove('hidden');
            }
        });
    }

    /* --- DOMContentLoaded setup --- */
    document.addEventListener('DOMContentLoaded', function () {
        attachAutoResize();
        attachCounters();
        setupLinkControls();
        setupPostControls();
        setupFAQControls();
        setupFormOverlay();

        // Attach auto-resize to follower message textareas
        document.querySelectorAll('.follower-message .message-input').forEach(function (field) {
            if (!field.dataset.autosizeReady) {
                field.dataset.autosizeReady = 'true';
                field.addEventListener('input', function () { autoResize(field); });
                autoResize(field);
            }
        });

        // Toast close button
        var closeBtn = document.getElementById('toast-close-btn');
        if (closeBtn) closeBtn.addEventListener('click', closeToast);

        // Show toast
        showToast();
    });

    /* --- Close reset modal on outside click --- */
    var resetModal = document.getElementById('resetModal');
    if (resetModal) {
        resetModal.addEventListener('click', function (e) {
            if (e.target === resetModal) {
                window.closeResetModal();
            }
        });
    }
})();
</script>
{% endblock %}
