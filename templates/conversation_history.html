{% extends "base.html" %}

{% block title %}Conversation History - CHATA{% endblock %}

{% block page_styles %}
    body {
        letter-spacing: 0.05em;
        text-transform: none;
    }
    .content-wrap { position: relative; z-index: 10; max-width: 900px; margin: 0 auto; padding: 2rem; padding-top: 100px; }
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--chata-blue);
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 1.5rem;
    }
    .back-link:hover { color: var(--chata-blue-light); }
    h1 {
        font-size: 1.75rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 0.5rem;
    }
    .subtitle { color: rgba(255,255,255,0.7); font-size: 0.95rem; margin-bottom: 1.5rem; }
    .conv-list { list-style: none; }
    .conv-row {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        margin-bottom: 0.75rem;
        overflow: hidden;
        transition: all 0.2s ease;
    }
    .conv-row:hover { background: rgba(255, 255, 255, 0.08); border-color: rgba(51, 102, 255, 0.3); }
    .conv-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        cursor: pointer;
        user-select: none;
    }
    .conv-head .label { font-weight: 500; color: #fff; }
    .conv-head .id { font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-left: 0.5rem; }
    .search-wrap { margin-bottom: 1.25rem; }
    .search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.2);
        background: rgba(255,255,255,0.06);
        color: #fff;
        font-size: 0.95rem;
    }
    .search-input::placeholder { color: rgba(255,255,255,0.5); }
    .search-input:focus { outline: none; border-color: var(--chata-blue); }
    .search-box { position: relative; }
    .search-box i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.5); pointer-events: none; }
    .conv-head .chevron { color: var(--chata-blue); transition: transform 0.2s; }
    .conv-row.open .conv-head .chevron { transform: rotate(180deg); }
    .conv-body {
        display: none;
        padding: 0 1.25rem 1rem;
        border-top: 1px solid rgba(255,255,255,0.08);
    }
    .conv-row.open .conv-body { display: block; }
    .conv-messages { margin-top: 0.75rem; }
    .msg {
        margin-bottom: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        font-size: 0.9rem;
        line-height: 1.4;
        text-transform: none;
    }
    .msg.user { background: rgba(51, 102, 255, 0.2); border-left: 3px solid var(--chata-blue); }
    .msg.bot { background: rgba(255,255,255,0.06); border-left: 3px solid rgba(255,255,255,0.3); }
    .msg-meta { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.25rem; }
    .load-more-wrap { text-align: center; margin-top: 0.75rem; }
    .load-more-btn {
        background: rgba(255,255,255,0.1);
        color: #fff;
        border: 1px solid rgba(255,255,255,0.2);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    .load-more-btn:hover { background: rgba(51, 102, 255, 0.2); border-color: var(--chata-blue); }
    .load-more-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .conv-loading { padding: 1rem; text-align: center; color: rgba(255,255,255,0.6); font-size: 0.9rem; }
    .empty-conv { padding: 1.5rem; text-align: center; color: rgba(255,255,255,0.6); }
    .msg.pending-approval { border-left-color: rgba(255, 193, 7, 0.9); background: rgba(255, 193, 7, 0.08); }
    .pending-approval-head { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; color: rgba(255, 193, 7, 0.95); font-size: 0.85rem; }
    .pending-approval-head i.fa-exclamation-triangle { font-size: 1rem; }
    .pending-approval-text { margin: 0.5rem 0; white-space: pre-wrap; word-break: break-word; }
    .pending-approval-note { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.5rem; }
    .pending-send-btn { margin-top: 0.5rem; padding: 0.5rem 1rem; background: var(--chata-blue); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.4rem; }
    .pending-send-btn:hover { background: var(--chata-blue-light); }
    .pending-send-btn:disabled { opacity: 0.6; cursor: not-allowed; }
{% endblock %}

{% block content %}
<div class="content-wrap">
    <a href="{{ url_for('dashboard_bp.dashboard') }}" class="back-link">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
    <h1>Conversation History</h1>
    <p class="subtitle">{{ connection_name }}</p>

    {% if conversations %}
    <div class="search-wrap">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" class="search-input" id="searchConv" placeholder="Search by username or account ID" autocomplete="off">
        </div>
    </div>
    <ul class="conv-list" id="convList">
        {% for c in conversations %}
        <li class="conv-row" data-connection-id="{{ connection_id }}" data-user-id="{{ (c.instagram_user_id|string) }}" data-username="{{ (c.username or '')|lower }}">
            <div class="conv-head">
                <span>
                    <span class="label">{% if c.username %}@{{ c.username }}{% else %}Account{% endif %}</span>
                    <span class="id">ID: {{ c.instagram_user_id }}</span>
                </span>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="conv-body">
                <div class="conv-messages"></div>
                <div class="load-more-wrap" style="display: none;">
                    <button type="button" class="load-more-btn" data-limit="10"><i class="fas fa-plus"></i> Load more</button>
                </div>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="empty-conv">No conversations yet. Messages will appear here once people message your Instagram account.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    var connectionId = {{ connection_id }};
    var searchEl = document.getElementById('searchConv');
    var listEl = document.getElementById('convList');
    if (searchEl && listEl) {
        searchEl.addEventListener('input', function() {
            var q = (searchEl.value || '').toLowerCase().trim();
            var rows = listEl.querySelectorAll('.conv-row');
            rows.forEach(function(row) {
                var uid = (row.dataset.userId || '').toLowerCase();
                var username = (row.dataset.username || '').toLowerCase();
                var show = !q || uid.indexOf(q) !== -1 || username.indexOf(q) !== -1;
                row.style.display = show ? '' : 'none';
            });
        });
    }
    var rows = document.querySelectorAll('.conv-row');
    rows.forEach(function(row) {
        var head = row.querySelector('.conv-head');
        var body = row.querySelector('.conv-body');
        var messagesEl = row.querySelector('.conv-messages');
        var loadMoreWrap = row.querySelector('.load-more-wrap');
        var loadMoreBtn = row.querySelector('.load-more-btn');
        var userId = row.dataset.userId;
        var loaded = 0;
        var total = 0;

        function renderMessages(messages) {
            messages.forEach(function(m) {
                if (m.message_text) {
                    var div = document.createElement('div');
                    div.className = 'msg user';
                    div.innerHTML = '<div>' + escapeHtml(m.message_text) + '</div>' + (m.created_at ? '<div class="msg-meta">' + escapeHtml(m.created_at) + '</div>' : '');
                    messagesEl.appendChild(div);
                }
                if (m.bot_response) {
                    var pending = m.sent_via_api === false || m.sent_via_api === 0;
                    var div = document.createElement('div');
                    div.className = 'msg bot' + (pending ? ' pending-approval' : '');
                    if (pending) {
                        div.innerHTML =
                            '<div class="pending-approval-head"><i class="fas fa-exclamation-triangle"></i> <span>The bot has generated the following message. Please approve before sending.</span></div>' +
                            '<div class="pending-approval-text">' + escapeHtml(m.bot_response) + '</div>' +
                            '<div class="pending-approval-note">We have added this feature temporarily for the Meta App Review. Messages will be sent automatically once the review is approved.</div>' +
                            '<button type="button" class="pending-send-btn" data-message-id="' + escapeHtml(String(m.id)) + '"><i class="fas fa-paper-plane"></i> Send</button>' +
                            (m.created_at ? '<div class="msg-meta">' + escapeHtml(m.created_at) + '</div>' : '');
                        messagesEl.appendChild(div);
                        div.querySelector('.pending-send-btn').addEventListener('click', function() {
                            var btn = this;
                            var mid = btn.getAttribute('data-message-id');
                            if (!mid) return;
                            btn.disabled = true;
                            btn.textContent = 'Sending\u2026';
                            fetch('/api/conversation-history/' + connectionId + '/' + encodeURIComponent(userId) + '/send-pending', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ message_id: parseInt(mid, 10) })
                            })
                                .then(function(r) { return r.json().then(function(data) { return { ok: r.ok, data: data }; }); })
                                .then(function(result) {
                                    if (result.ok && result.data.success) {
                                        fetchMessages(0, 10, false);
                                    } else {
                                        btn.disabled = false;
                                        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
                                        alert(result.data.error || 'Failed to send');
                                    }
                                })
                                .catch(function() {
                                    btn.disabled = false;
                                    btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
                                    alert('Failed to send');
                                });
                        });
                    } else {
                        div.innerHTML = '<div>Bot: ' + escapeHtml(m.bot_response) + '</div>' + (m.created_at ? '<div class="msg-meta">' + escapeHtml(m.created_at) + '</div>' : '');
                        messagesEl.appendChild(div);
                    }
                }
            });
        }

        function escapeHtml(s) {
            if (!s) return '';
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function fetchMessages(offset, limit, append) {
            if (!append) messagesEl.innerHTML = '<div class="conv-loading">Loading\u2026</div>';
            fetch('/api/conversation-history/' + connectionId + '/' + encodeURIComponent(userId) + '/messages?limit=' + limit + '&offset=' + offset)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (!append) messagesEl.innerHTML = '';
                    total = data.total || 0;
                    var ms = data.messages || [];
                    loaded = (append ? loaded : 0) + ms.length;
                    renderMessages(ms);
                    if (loaded < total && total > 10) {
                        loadMoreWrap.style.display = 'block';
                        loadMoreBtn.disabled = false;
                        loadMoreBtn.onclick = function() {
                            loadMoreBtn.disabled = true;
                            fetchMessages(loaded, 10, true);
                        };
                    } else {
                        loadMoreWrap.style.display = 'none';
                    }
                    loadMoreBtn.disabled = false;
                })
                .catch(function() {
                    if (!append) messagesEl.innerHTML = '<div class="conv-loading">Could not load messages.</div>';
                });
        }

        head.addEventListener('click', function() {
            var isOpen = row.classList.toggle('open');
            if (isOpen && messagesEl.children.length === 0) {
                fetchMessages(0, 10, false);
            }
        });
    });
})();
</script>
{% endblock %}
